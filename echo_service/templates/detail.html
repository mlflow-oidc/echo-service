{% extends 'base.html' %}
{% block content %}
  <a class="btn btn-sm btn-outline-secondary mb-3" href="/">← Back</a>
  <h2 class="h5">Webhook {{ entry.id }}</h2>
  <div class="row mt-3">
    <div class="col-md-6">
      <h6>Metadata</h6>
      <table class="table table-sm table-borderless">
        <tr><th>Received</th><td>{{ entry.received_at }}</td></tr>
        <tr><th>IP</th><td>{{ entry.client_ip }}</td></tr>
        <tr><th>User-Agent</th><td><code>{{ entry.user_agent }}</code></td></tr>
        <tr><th>Method</th><td>{{ entry.method }}</td></tr>
        <tr><th>Path</th><td>{{ entry.path }}</td></tr>
      </table>

      <h6>Headers</h6>
      <pre class="small">{% for k,v in entry.headers.items() %}{{ k }}: {{ v }}
{% endfor %}</pre>

      <h6 class="mt-3">Verify MLflow Signature</h6>
      <div class="input-group mb-3" style="max-width:400px;">
        <input id="secret-input" type="password" class="form-control" placeholder="Enter webhook secret">
        <button id="verify-btn" class="btn btn-outline-primary">Verify</button>
      </div>
      <div id="verify-result" class="small"></div>

    </div>
    <div class="col-md-6">
      <h6>Body</h6>
      <pre class="bg-light p-3 small overflow-auto">{{ pretty_body }}</pre>
    </div>
  </div>

  <script>
  document.getElementById('verify-btn').addEventListener('click', async function(){
    const secret = document.getElementById('secret-input').value;
    const resEl = document.getElementById('verify-result');
    resEl.textContent = 'Verifying...';
    try {
      const resp = await fetch(`/api/webhooks/{{ entry.id }}/verify`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({secret})
      });
      if (resp.ok) {
        resEl.innerHTML = '<span class="text-success">Signature verified ✅</span>';
      } else {
        const j = await resp.json();
        resEl.innerHTML = `<span class="text-danger">Verification failed: ${j.detail || j.error || resp.statusText}</span>`;
      }
    } catch (e) {
      resEl.innerHTML = `<span class="text-danger">Error: ${e.message}</span>`;
    }
  });
  </script>
{% endblock %}